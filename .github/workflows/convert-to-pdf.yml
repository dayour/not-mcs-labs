# .github/workflows/convert-to-pdf.yml

name: Labs to HTML and PDF
# This workflow is triggered on pushes to the repository or manually.
on:
  push:
    branches:
      - main
    # Paths can be used to only trigger actions when you have edited certain files, such as a file within the /labs directory
    paths:
      - "labs/*/*.md"
      - "labs/*/images/**"
      - ".github/styles/**"
  # Allow manual triggering of the workflow
  workflow_dispatch:

jobs:
  converttopdf:
    name: Build PDF
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      # Setup Pandoc using dedicated action (much faster than apt-get)
      - name: Setup Pandoc
        uses: pandoc/actions/setup@main
        with:
          version: 3.1.3

      # Install wkhtmltopdf and fonts
      - name: Install wkhtmltopdf and fonts
        run: |
          echo "Installing wkhtmltopdf..."
          
          # Use wget to download specific version (faster than apt)
          wget -q https://github.com/wkhtmltopdf/packaging/releases/download/0.12.6.1-3/wkhtmltox_0.12.6.1-3.jammy_amd64.deb
          sudo apt-get install -y ./wkhtmltox_0.12.6.1-3.jammy_amd64.deb
          rm wkhtmltox_0.12.6.1-3.jammy_amd64.deb
          echo "✓ wkhtmltopdf installed"
          
          # Install fonts for emoji support
          sudo apt-get install -y --no-install-recommends fonts-noto-color-emoji || echo "Warning: Could not install emoji fonts"
          echo "✓ Emoji fonts installation attempted"

          # Verify installations
          pandoc --version
          wkhtmltopdf --version
        timeout-minutes: 5

      # Convert labs to HTML first (needed for PDF generation)
      - name: Convert labs to HTML
        run: |
          # Convert each README.md to HTML in its own directory
          for lab_dir in labs/*/; do
            if [ -d "$lab_dir" ] && [ -f "${lab_dir}README.md" ]; then
              lab_name=$(basename "$lab_dir")
              echo "Converting $lab_name to HTML..."
              
              # Change to the lab directory to ensure relative image paths work
              cd "$lab_dir"
              
              # Preprocess markdown for GitHub-style callouts and emoji preservation
              cp "README.md" "${lab_name}_processed.md"
              
              # Convert GitHub-style callouts to HTML divs with classes
              sed -i 's/> \[!NOTE\]/> <div class="note">**Note:** /g' "${lab_name}_processed.md"
              sed -i 's/> \[!TIP\]/> <div class="tip">**Tip:** /g' "${lab_name}_processed.md"
              sed -i 's/> \[!IMPORTANT\]/> <div class="warning">**Important:** /g' "${lab_name}_processed.md"
              sed -i 's/> \[!WARNING\]/> <div class="warning">**Warning:** /g' "${lab_name}_processed.md"
              sed -i 's/> \[!CAUTION\]/> <div class="warning">**Caution:** /g' "${lab_name}_processed.md"
              
              # Add closing div tags for callouts (simple approach - assumes single line callouts)
              sed -i 's/\(> <div class="[^"]*">.*\)$/\1<\/div>/g' "${lab_name}_processed.md"
              
              # CRITICAL: Remove emojis from headers FIRST, before Pandoc processes them
              # This ensures Pandoc generates consistent TOC links and header IDs
              echo "Removing emojis from headers in $lab_name BEFORE Pandoc processing..."
              sed -i 's/^## [^a-zA-Z0-9]*\([a-zA-Z].*\)$/## \1/g' "${lab_name}_processed.md"
              sed -i 's/^### [^a-zA-Z0-9]*\([a-zA-Z].*\)$/### \1/g' "${lab_name}_processed.md"
              sed -i 's/^#### [^a-zA-Z0-9]*\([a-zA-Z].*\)$/#### \1/g' "${lab_name}_processed.md"
              
              # Fix any manual anchor links to match cleaned headers
              # Remove emojis and leading dashes from anchor links
              sed -i 's|(#[^a-zA-Z0-9]*-*\([a-zA-Z][^)]*\))|(#\1)|g' "${lab_name}_processed.md"
              
              # Convert to HTML with custom CSS (no TOC for individual pages)
              if pandoc "${lab_name}_processed.md" \
                -o "${lab_name}.html" \
                --standalone \
                --self-contained \
                --css="../../.github/styles/html.css" \
                --html-q-tags \
                --section-divs \
                --id-prefix="" \
                --metadata title="$lab_name - Microsoft Copilot Studio Labs" \
                -f markdown+auto_identifiers+gfm_auto_identifiers+emoji+header_attributes \
                -t html5 2>/dev/null; then
                echo "✓ Successfully converted $lab_name to HTML"
                
                # Remove the title block header (keep <title> in <head>, remove <header> in body)
                perl -0pi -e 's/<header id="title-block-header">.*?<\/header>\n?//s' "${lab_name}.html"
                
                # Post-process HTML to fix anchor links and remove problematic IDs
                # Remove empty or invalid IDs that might break navigation
                sed -i 's/id=""//g' "${lab_name}.html"
                sed -i 's/id="[[:space:]]*"//g' "${lab_name}.html"
                
                # Ensure proper anchor link format in HTML
                # Fix links that might have been broken during conversion
                sed -i 's/href="#[[:space:]]*\([^"[:space:]]*\)[[:space:]]*"/href="#\1"/g' "${lab_name}.html"
                
                # Add name attributes to headers for better anchor compatibility
                # This ensures that both id="section" and name="section" work for navigation
                sed -i 's/<h\([1-6]\) id="\([^"]*\)"/<h\1 id="\2" name="\2"/g' "${lab_name}.html"
                
                # Also add standalone anchor tags before headers as backup
                sed -i 's/<h\([1-6]\) id="\([^"]*\)" name="\([^"]*\)"/<a name="\2"><\/a><h\1 id="\2" name="\3"/g' "${lab_name}.html"
                
                # Make external links open in new window
                # Add target="_blank" and rel="noopener noreferrer" to external links (http/https)
                # This regex matches links that start with http:// or https:// and adds the attributes
                sed -i 's/<a href="\(https\?:\/\/[^"]*\)"/<a href="\1" target="_blank" rel="noopener noreferrer"/g' "${lab_name}.html"
                
                # Add simple favicon for consistent branding (blue circle with L)
                sed -i 's|</head>|  <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj4KICA8Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0NSIgZmlsbD0iIzJCNTc5QSIvPgogIDx0ZXh0IHg9IjUwIiB5PSI2NSIgZm9udC1mYW1pbHk9IkFyaWFsLHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iNDUiIGZvbnQtd2VpZ2h0PSJib2xkIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+TDwvdGV4dD4KPC9zdmc+">\n</head>|' "${lab_name}.html"
                
                echo "✓ Successfully converted $lab_name to HTML with favicon"
              else
                # Try fallback conversion without CSS
                echo "Trying fallback HTML method for $lab_name..."
                pandoc "${lab_name}_processed.md" -o "${lab_name}.html" \
                  --standalone \
                  --section-divs \
                  --toc \
                  --id-prefix="" \
                  -f markdown+auto_identifiers+gfm_auto_identifiers+emoji \
                  -t html5 2>/dev/null && echo "✓ Fallback HTML conversion succeeded for $lab_name"
              fi
              
              # Cleanup processed file
              rm -f "${lab_name}_processed.md"
              
              # Change back to root directory
              cd - > /dev/null
            fi
          done

          echo "Generated HTML count: $(find labs -name "*.html" -type f | wc -l)"

      # Convert HTML to PDF (preserves hyperlinks better)
      - name: Convert HTML to PDF
        run: |
          # Convert each HTML file to PDF in its own directory
          for lab_dir in labs/*/; do
            if [ -d "$lab_dir" ]; then
              lab_name=$(basename "$lab_dir")
              html_file="${lab_dir}${lab_name}.html"
              
              if [ -f "$html_file" ]; then
                echo "Converting $lab_name HTML to PDF..."
                
                # Change to the lab directory
                cd "$lab_dir"
                
                # Debug: Check HTML file before PDF conversion
                echo "Checking HTML structure for $lab_name:"
                echo "First few links in HTML:"
                grep -o '<a href="#[^"]*"[^>]*>[^<]*</a>' "${lab_name}.html" | head -3 || echo "No internal links found in HTML"
                
                # Convert HTML to PDF using wkhtmltopdf (preserves hyperlinks and emojis)
                if wkhtmltopdf \
                  --page-size Letter \
                  --margin-top 0.75in \
                  --margin-bottom 0.75in \
                  --margin-left 0.75in \
                  --margin-right 0.75in \
                  --enable-local-file-access \
                  --enable-internal-links \
                  --outline \
                  --outline-depth 4 \
                  --print-media-type \
                  --no-stop-slow-scripts \
                  --javascript-delay 2000 \
                  --encoding utf-8 \
                  --disable-smart-shrinking \
                  --debug-javascript \
                  "${lab_name}.html" "${lab_name}.pdf" 2>/dev/null; then
                  echo "✓ Successfully converted $lab_name HTML to PDF"
                else
                  echo "✗ Failed to convert $lab_name HTML to PDF"
                fi
                
                # Change back to root directory
                cd - > /dev/null
              else
                echo "✗ HTML file not found for $lab_name"
              fi
            fi
          done

          echo "Generated PDF count: $(find labs -name "*.pdf" -type f | wc -l)"

      # Commit PDFs and HTML files back to the repository
      - name: Commit PDFs and HTML files to repository
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          echo "Current git status:"
          git status

          echo ""
          echo "Checking for generated files to add:"
          echo "PDF files:"
          find labs -name "*.pdf" -type f
          echo "HTML files:"
          find labs -name "*.html" -type f

          # Sync with latest remote changes to avoid push conflicts during long runs
          git pull --rebase --autostash origin main

          # Add all generated files
          git add labs/

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No generated files to commit"
          else
            echo "Committing generated PDF and HTML files..."
            git commit -m "Auto-generated PDFs and HTML files for lab documentation [skip ci]"
            echo "Pushing changes..."
            git push
          fi
